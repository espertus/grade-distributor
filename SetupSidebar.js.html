<script src="https://code.jquery.com/jquery-3.5.1.min.js"
  integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>

<script>
  $(document).ready(function() {  
    var status = $('#submit-status');
    status.hide();
    $('#create').prop('disabled', true);

    // https://stackoverflow.com/a/3321693/631051
    $('#validate').click(function(e) {
      e.preventDefault();
      validate();
      return true;
    });
  
    $('#create').click(function(e) {
      e.preventDefault();
      create();
      return true;
    });
  })

  function showValidationError(message) {
    var status = $('#validation-status');
    status.addClass('error');
    status.text(message);
    status.show();
  }

  function hideValidationError() {
    var status = $('#validation-status');
    status.removeClass('error');
    status.hide();
  }

  function showValidationSuccess() {
    var button = $('#validate');
    button.prop('disabled', true);
    var status = $('#validation-status');
    status.text('Names and emails validated');
    status.show();
  }

  var setIntervalId = false

  // If the spreadsheet is edited after successful validation,
  // it should no longer be considered validated.
  function requireValidation() {
    var button = $('#validate');
    button.prop('disabled', false);
    var status = $('#validation-status');
    if (!status.hasClass('error')) {
        status.text('');
        status.hide();
    }
  }

  function showError(message) {
    var status = $('#submit-status');
    status.addClass('error');
    status.text(message);
    status.show();
  }

  function showStatus(message) {
    var status = $('#submit-status');
    status.removeClass('error')
    status.text(message);
    status.show();
  }

  const CHECK_VALIDATION_MS = 500;

  function validate() {
    this.disabled = true;
    hideValidationError();
    google.script.run
      .withSuccessHandler(
        function(noErrors) {
          setIntervalId = setInterval(checkValidation, CHECK_VALIDATION_MS);
          showValidationSuccess();
          $('#create').prop('disabled', false);
        })
      .withFailureHandler(
          function(error) {
            showValidationError(error);
            $('#validate').prop('disabled', false);
          })
      .validateStudentSetupSheet();
  }
  
  function checkValidation() {
    google.script.run
      .withSuccessHandler(
        function(isValidated) {
          if (!isValidated) {
            clearInterval(setIntervalId);
            requireValidation();
          }
        }
      )
      .getIsValidated();
  }

  function create() {
    this.disabled = true;
    showStatus('Running...');

    var topFolderName = $('#fname').val();
    var prefix = $('#prefix').val();
    var suffix = $('#suffix').val();
    var giveEditAccess = $('#edit').is(':checked');
    var emailStudent = $('#notify').is(':checked');

    showStatus("Starting to run...");
    google.script.run
      .withSuccessHandler(
        function(numStudents) {
          showStatus('Created configuration and folders for ' + numStudents + ' student' + (numStudents == 1 ? '.' : 's.') );
        })
      .withFailureHandler(
        function(error) {
          showError('Error! ' + error);
        })
      .createStudentSheets(topFolderName, prefix, suffix, giveEditAccess, emailStudent);
  }


</script>